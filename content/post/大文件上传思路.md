---
title: "大文件分片上传"
date: 2024-04-12T15:22:57+08:00
draft: false
---

大文件上传，在弱网环境下，容易上传失败，体验很差，所以我们需要分片上传主要解决
1. 断点续传
2. 文件秒传

## 前端实现
### 分片
利用 File 对象的 slice() 方法，可以将大文件分割成多个 5M 小片段
```javascript
file.slice(cur, cur + size)
```

### HASH
根据文件片段增量计算出 hash 值，因为会调用FileReader读取整个文件，比较耗时，所以可以利用 web worker 优化
```javascript
function calcHash(chunks) {
    return new Promise(resolve => {
        const spark = new SparkMD5()
        const _read = (i) => {
            if (i >= chunks.length) {
                resolve(spark.end())
                return
            }
            const blob = chunks[i]
            const render = new FileReader()
            render.onload = (e) => {
                const bytes = e.target.result
                spark.append(bytes)

                _read(++i)
            }

            render.readAsArrayBuffer(blob)
        }
        _read(0)
    })
}
```

### 上传
上传前需要一个检查接口，根据hash判断文件是否已经上传过，
1. 如果上传过，则前端直接提示上传成功
2. 如果上传过，但是前后端切片数量不一致，则前端需要继续上传剩余的切片
3. 如果没有上传过，则前端开始上传

## 后端实现
### 保存
后端接受到切片上传接口，创建一个以 hash 值为文件名的目录，并保存切片文件

### 合并
合并有2种策略
1. 文件上传完成后，由前端立即发起合并请求，后端合并切片文件
2. 懒执行，前端发起下载请求，后端合并切片文件，并返回合并后的文件

### 优化
